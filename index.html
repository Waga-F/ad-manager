<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Manager Pro v7.1 (Dark)</title>
    <!-- Tailwind CSS (Design) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js (Logic) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- FontAwesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c',
                            950: '#0d1117',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #0f172a; color: #e2e8f0; }
        
        /* ダークモード用スクロールバー */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }

        /* ガントチャート用のグリッド線 (Dark) */
        .gantt-grid-line {
            border-right: 1px dashed #334155;
        }
    </style>
</head>
<body class="h-screen overflow-hidden bg-slate-900 text-slate-200">

    <div id="app" class="flex h-full">

        <!-- Sidebar -->
        <aside :class="isSidebarOpen ? 'w-64 opacity-100' : 'w-0 opacity-0'" class="bg-slate-950 text-slate-300 flex flex-col shadow-2xl z-20 flex-shrink-0 border-r border-slate-800 transition-all duration-300 ease-in-out overflow-hidden whitespace-nowrap">
            <div class="p-6 border-b border-slate-800 flex items-center min-w-[16rem]">
                <i class="fa-solid fa-layer-group text-blue-500 mr-3 text-xl"></i>
                <h1 class="text-lg font-bold tracking-wider text-white">Ad Manager</h1>
            </div>
            
            <nav class="flex-1 overflow-y-auto py-4 min-w-[16rem]">
                <ul>
                    <!-- 全タスク一覧 -->
                    <li @click="selectClient(null)" 
                        :class="{'bg-blue-600 text-white': currentClient === null, 'hover:bg-slate-800': currentClient !== null}"
                        class="px-6 py-3 cursor-pointer transition-colors flex items-center justify-between border-l-4 border-transparent">
                        <span class="text-sm font-medium"><i class="fa-solid fa-list-check mr-3 w-5"></i>全タスク</span>
                        <span v-if="allPendingTasksCount > 0" class="bg-slate-700 text-slate-200 text-xs px-2 py-0.5 rounded-full">{{ allPendingTasksCount }}</span>
                    </li>

                    <li class="px-6 py-3 mt-4 text-xs font-bold text-slate-500 uppercase tracking-widest flex justify-between items-center group">
                        <span>Clients</span>
                        <button @click="openSettings('clients')" class="text-slate-600 hover:text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity" title="クライアント編集">
                            <i class="fa-solid fa-gear"></i>
                        </button>
                    </li>

                    <li v-if="clients.length === 0" class="px-6 py-4 text-xs text-slate-500 italic text-center">
                        顧客未登録<br>設定から追加してください
                    </li>

                    <!-- 顧客リスト -->
                    <li v-for="client in clients" :key="client.id" 
                        @click="selectClient(client)"
                        :class="{'bg-slate-800 border-l-4 border-blue-500 text-white': currentClient && currentClient.id === client.id, 'hover:bg-slate-800 border-l-4 border-transparent text-slate-400 hover:text-slate-200': !currentClient || currentClient.id !== client.id}"
                        class="px-6 py-3 cursor-pointer transition-colors flex justify-between items-center text-sm">
                        <span class="truncate pr-2">
                            <span class="inline-block w-2 h-2 rounded-full mr-2" :class="getColor(client.color, 'bg')"></span>
                            {{ client.name }}
                        </span>
                        <span v-if="getPendingCount(client.id) > 0" class="bg-slate-700 text-blue-300 text-xs px-2 py-0.5 rounded-full">{{ getPendingCount(client.id) }}</span>
                    </li>
                </ul>
            </nav>

            <!-- 設定ボタンエリア -->
            <div class="p-4 border-t border-slate-800 bg-slate-950 min-w-[16rem]">
                <button @click="openSettings('clients')" class="w-full py-2 px-4 bg-slate-800 hover:bg-slate-700 rounded text-sm text-slate-400 hover:text-white transition flex items-center justify-center">
                    <i class="fa-solid fa-sliders mr-2"></i> 設定・マスタ管理
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden relative bg-slate-900">
            
            <!-- Header -->
            <header class="bg-slate-900 shadow-lg z-10 px-8 py-5 flex justify-between items-center border-b border-slate-800 flex-shrink-0">
                <div class="flex items-center flex-1 min-w-0 mr-4">
                    <!-- Sidebar Toggle Button -->
                    <button @click="isSidebarOpen = !isSidebarOpen" class="text-slate-400 hover:text-white mr-5 transition focus:outline-none" title="メニュー開閉">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>

                    <div class="min-w-0">
                        <h2 class="text-2xl font-bold text-white flex items-center truncate">
                            <span v-if="currentClient" class="mr-2 text-blue-500 flex-shrink-0"><i class="fa-regular fa-building"></i></span>
                            <span class="truncate">{{ currentClient ? currentClient.name : '全案件タスク一覧' }}</span>
                        </h2>
                        <p class="text-sm text-slate-400 mt-1 truncate">
                            {{ currentClient ? '担当案件のバナー切り替え・入稿スケジュール' : 'すべてのクライアントの進行状況サマリー' }}
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-3 flex-shrink-0">
                    <!-- View Toggle -->
                    <div class="bg-slate-800 p-1 rounded-lg flex border border-slate-700">
                        <button @click="viewMode = 'list'" :class="viewMode === 'list' ? 'bg-slate-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-200'" class="px-3 py-1.5 rounded-md text-sm font-bold transition flex items-center">
                            <i class="fa-solid fa-list mr-2"></i>
                        </button>
                        <button @click="viewMode = 'board'" :class="viewMode === 'board' ? 'bg-slate-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-200'" class="px-3 py-1.5 rounded-md text-sm font-bold transition flex items-center">
                            <i class="fa-solid fa-table-columns mr-2"></i>
                        </button>
                        <button @click="viewMode = 'gantt'" :class="viewMode === 'gantt' ? 'bg-slate-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-200'" class="px-3 py-1.5 rounded-md text-sm font-bold transition flex items-center">
                            <i class="fa-solid fa-chart-gantt mr-2"></i>
                        </button>
                    </div>

                    <button @click="openTaskModal" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2.5 rounded-lg shadow-lg hover:shadow-blue-900/50 transition transform hover:-translate-y-0.5 flex items-center font-bold text-sm border border-blue-500">
                        <i class="fa-solid fa-plus mr-2"></i> タスク追加
                    </button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="flex-1 overflow-hidden bg-slate-900 flex flex-col">
                
                <!-- FILTER BAR -->
                <div v-if="viewMode !== 'gantt'" class="px-8 pt-6 pb-2 flex-shrink-0">
                    <div class="flex items-center space-x-2 overflow-x-auto pb-2 no-scrollbar">
                        <span class="text-xs font-bold text-slate-500 mr-2 uppercase tracking-wider flex-shrink-0">Filter:</span>
                        <button @click="filterPlatform = ''" :class="filterPlatform === '' ? 'bg-slate-700 text-white ring-2 ring-slate-600' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'" class="px-4 py-1.5 rounded-full text-sm font-medium shadow-sm border border-slate-700 transition-all flex-shrink-0">全て</button>
                        <button v-for="pf in platforms" :key="pf.name" @click="filterPlatform = pf.name" 
                            :class="filterPlatform === pf.name ? 'bg-blue-900/50 text-blue-200 border-blue-700 ring-2 ring-blue-900' : 'bg-slate-800 text-slate-400 hover:bg-slate-700 border-slate-700'"
                            class="px-4 py-1.5 rounded-full text-sm font-medium border shadow-sm transition-all whitespace-nowrap flex-shrink-0 flex items-center">
                            <span class="w-2 h-2 rounded-full mr-2" :class="getColor(pf.color, 'bg')"></span>
                            {{ pf.name }}
                        </button>
                    </div>
                </div>

                <!-- ================= LIST VIEW ================= -->
                <div v-if="viewMode === 'list'" class="flex-1 overflow-y-auto px-8 pb-8 pt-4">
                    <div v-if="groupedFilteredTasks.length === 0" class="text-center text-slate-500 py-20">
                        <p class="font-medium">タスクがありません</p>
                    </div>
                    <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <div v-for="taskGroup in groupedFilteredTasks" :key="taskGroup.uniqueKey" class="bg-slate-800 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 flex flex-col group border border-slate-700 overflow-hidden relative">
                            <div :class="getClientColor(taskGroup.clientId, 'border')" class="absolute left-0 top-0 bottom-0 w-1.5 border-l-4"></div>
                            <div class="p-5 flex-1 pl-6">
                                <div class="flex justify-between items-start mb-3">
                                    <div v-if="!currentClient" class="text-xs font-bold text-slate-300 flex items-center">
                                        <span class="w-2 h-2 rounded-full mr-2" :class="getClientColor(taskGroup.clientId, 'bg')"></span>
                                        {{ getClientName(taskGroup.clientId) }}
                                    </div>
                                    <div v-else class="h-4"></div> 
                                    <span :class="getStatusClass(taskGroup.status)" class="text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center border">
                                        <i :class="getStatusIcon(taskGroup.status)" class="mr-1"></i> {{ getStatusLabel(taskGroup.status) }}
                                    </span>
                                </div>
                                <h3 class="font-bold text-slate-100 text-lg mb-2 leading-snug cursor-pointer hover:text-blue-400 transition" @click="editGroup(taskGroup)">{{ taskGroup.title }}</h3>
                                <div class="flex flex-wrap gap-1.5 mb-3">
                                    <span v-for="pf in taskGroup.platforms" :key="pf" class="px-2 py-0.5 rounded text-[10px] font-medium border" :class="getPlatformColorStyle(pf)">
                                        {{ pf }}
                                    </span>
                                </div>
                                <p class="text-xs text-slate-400 mb-4 line-clamp-2 min-h-[1.5em]">{{ taskGroup.description || '詳細なし' }}</p>
                                <div class="flex flex-col space-y-1.5">
                                    <div class="flex items-center text-sm font-medium text-slate-300 bg-slate-900/50 p-2 rounded border border-slate-700">
                                        <i class="fa-regular fa-calendar text-slate-500 mr-2"></i>
                                        {{ formatDateRange(taskGroup) }}
                                        <span v-if="isOverdue(taskGroup)" class="ml-auto text-xs text-red-400 font-bold">期限切れ</span>
                                    </div>
                                    <div v-if="taskGroup.createdAt" class="text-[10px] text-slate-500 text-right px-1">
                                        Created: {{ formatCreatedDate(taskGroup.createdAt) }}
                                    </div>
                                </div>
                            </div>
                            <div class="bg-slate-900/30 px-5 py-3 border-t border-slate-700 flex justify-between items-center pl-6">
                                <button @click="toggleGroupStatus(taskGroup)" class="text-xs font-bold text-slate-400 hover:text-blue-400 flex items-center transition">
                                    <i class="fa-solid fa-rotate mr-1"></i> ステータス一括変更
                                </button>
                                <div class="opacity-0 group-hover:opacity-100 transition-opacity flex space-x-3">
                                    <button @click="duplicateGroup(taskGroup)" class="text-slate-500 hover:text-green-400 transition" title="複製して新規作成">
                                        <i class="fa-regular fa-copy"></i>
                                    </button>
                                    <button @click="editGroup(taskGroup)" class="text-slate-500 hover:text-blue-400 transition" title="編集">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                    <button @click="deleteGroup(taskGroup)" class="text-slate-500 hover:text-red-400 transition" title="一括削除">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ================= BOARD VIEW ================= -->
                <div v-else-if="viewMode === 'board'" class="flex-1 overflow-x-auto overflow-y-hidden px-8 pb-8 pt-4">
                     <div class="flex space-x-4 h-full">
                        <div v-for="col in boardData" :key="col.client.id" class="w-80 bg-slate-800 rounded-xl border border-slate-700 flex-shrink-0 flex flex-col max-h-full">
                            <div class="p-4 border-b border-slate-700 bg-slate-800 rounded-t-xl sticky top-0 z-10 flex justify-between items-center border-t-4" :class="getColor(col.client.color, 'border')">
                                <div class="font-bold text-slate-200 truncate pr-2 flex items-center">
                                    <i class="fa-regular fa-building text-slate-500 mr-2 text-sm"></i>
                                    {{ col.client.name }}
                                </div>
                                <span class="bg-slate-700 text-slate-400 text-xs px-2 py-0.5 rounded-full">{{ col.tasks.length }}</span>
                            </div>
                            <div class="flex-1 overflow-y-auto p-3 space-y-3 bg-slate-800/50">
                                <div v-for="taskGroup in col.tasks" :key="taskGroup.uniqueKey" class="bg-slate-700/50 p-3 rounded-lg border border-slate-600 hover:border-blue-500/50 transition cursor-pointer group relative hover:shadow-md" @click="editGroup(taskGroup)">
                                    <div class="mb-2">
                                        <div class="flex justify-between items-start mb-1">
                                            <div class="flex flex-wrap gap-1 max-w-[80%]">
                                                <span v-for="pf in taskGroup.platforms" :key="pf" class="text-[9px] px-1.5 py-0.5 rounded border" :class="getPlatformColorStyle(pf)">
                                                    {{ pf }}
                                                </span>
                                            </div>
                                            <span :class="getStatusDotClass(taskGroup.status)" class="w-2 h-2 rounded-full mt-1 flex-shrink-0"></span>
                                        </div>
                                        <h4 class="text-sm font-bold text-slate-200 mb-1 leading-tight group-hover:text-blue-400 mt-1">{{ taskGroup.title }}</h4>
                                        <div class="flex justify-between items-end mt-2">
                                            <div class="text-[10px] text-slate-400">
                                                <i class="fa-regular fa-calendar mr-1"></i>{{ formatDate(taskGroup.date) }}
                                            </div>
                                            <div v-if="taskGroup.createdAt" class="text-[9px] text-slate-600">
                                                {{ formatCreatedDateShort(taskGroup.createdAt) }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button @click.stop="duplicateGroup(taskGroup)" class="text-slate-500 hover:text-green-400 p-1" title="複製"><i class="fa-regular fa-copy"></i></button>
                                    </div>
                                </div>
                                <div v-if="col.tasks.length === 0" class="text-center text-slate-600 text-xs py-4">
                                    タスクなし
                                </div>
                            </div>
                        </div>
                        <div class="w-4"></div>
                     </div>
                </div>

                <!-- ================= GANTT VIEW ================= -->
                <div v-else-if="viewMode === 'gantt'" class="flex-1 flex flex-col h-full overflow-hidden">
                    <div class="px-8 py-4 bg-slate-900 border-b border-slate-800 flex justify-between items-center flex-shrink-0">
                        <div class="flex items-center space-x-4">
                            <button @click="changeGanttMonth(-1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-800 text-slate-400 transition"><i class="fa-solid fa-chevron-left"></i></button>
                            <span class="text-lg font-bold text-slate-200 w-32 text-center">{{ ganttYear }}年 {{ ganttMonth + 1 }}月</span>
                            <button @click="changeGanttMonth(1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-800 text-slate-400 transition"><i class="fa-solid fa-chevron-right"></i></button>
                            <button @click="resetGanttDate" class="text-sm text-blue-400 hover:underline">今日へ戻る</button>
                        </div>
                        <div class="flex items-center space-x-4 text-xs text-slate-500">
                             <div class="flex items-center"><span class="w-3 h-3 bg-amber-500 rounded-sm mr-1"></span> 予定</div>
                             <div class="flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-sm mr-1"></span> 掲載中</div>
                             <div class="flex items-center"><span class="w-3 h-3 bg-emerald-500 rounded-sm mr-1"></span> 完了</div>
                        </div>
                    </div>

                    <div class="flex-1 flex overflow-hidden bg-slate-900">
                        <div class="w-48 flex-shrink-0 border-r border-slate-800 bg-slate-900 overflow-hidden flex flex-col">
                            <div class="h-10 border-b border-slate-800 bg-slate-900"></div> 
                            <div class="overflow-y-hidden flex-1" ref="ganttSidebar">
                                <div v-for="row in ganttRows" :key="row.key" class="h-16 flex items-center px-4 border-b border-slate-800 text-sm font-bold text-slate-300 truncate" :title="row.label">
                                    <span class="w-2 h-2 rounded-full mr-2 flex-shrink-0" :class="currentClient ? getPlatformColorDot(row.key) : getClientColor(row.clientId, 'bg')"></span>
                                    <span class="truncate">{{ row.label }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex-1 overflow-x-auto overflow-y-auto relative bg-slate-900" ref="ganttScrollContainer">
                            <div :style="{ width: (daysInMonth.length * 40) + 'px' }" class="min-w-full">
                                <div class="flex h-10 border-b border-slate-800 bg-slate-900 sticky top-0 z-10">
                                    <div v-for="day in daysInMonth" :key="day.date" 
                                        :class="{'bg-blue-900/30 text-blue-400': day.isToday, 'text-red-400': day.isHoliday, 'text-slate-400': !day.isHoliday && !day.isToday}"
                                        class="flex-1 min-w-[40px] flex flex-col items-center justify-center border-r border-slate-800 text-xs font-medium">
                                        <span>{{ day.day }}</span>
                                        <span class="text-[10px] opacity-50">{{ day.weekDay }}</span>
                                    </div>
                                </div>

                                <div v-for="row in ganttRows" :key="row.key" class="h-16 border-b border-slate-800 relative">
                                    <div class="absolute inset-0 flex pointer-events-none">
                                        <div v-for="day in daysInMonth" :key="'line-'+day.date" 
                                             :class="{'bg-blue-900/10': day.isToday}"
                                             class="flex-1 min-w-[40px] border-r border-slate-800 border-dashed h-full opacity-50">
                                        </div>
                                    </div>

                                    <div v-for="task in row.tasks" :key="task.id" 
                                         @click="editGroup({ ...task, originalIds: [task.id], platforms: [task.platform], targetPlatforms: [task.platform] })" 
                                         :style="getTaskStyle(task)"
                                         :class="[
                                            task.status === 'Done' ? 'bg-emerald-600 hover:bg-emerald-500 border-emerald-400' : 
                                            (task.status === 'Live' ? 'bg-blue-600 hover:bg-blue-500 border-blue-400' : 'bg-amber-600 hover:bg-amber-500 border-amber-400'),
                                            getTaskStyle(task).isPoint ? 'rounded-full' : 'rounded-md'
                                         ]"
                                         class="absolute h-8 top-4 shadow-lg cursor-pointer transition-all z-10 flex items-center justify-center group overflow-hidden border text-white text-xs font-bold px-2 whitespace-nowrap">
                                        <i v-if="getTaskStyle(task).isPoint" class="fa-solid fa-diamond text-[10px]"></i>
                                        <span v-else class="truncate w-full drop-shadow-md">{{ task.title }}</span>
                                        <div class="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 bg-slate-950 text-slate-200 text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-20 shadow-xl border border-slate-700">
                                            {{ task.title }} ({{ formatDateRange(task) }}) - {{ task.status === 'Done' ? '完了' : (task.status === 'Live' ? '掲載中' : '予定') }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Task Modal -->
        <transition name="modal">
            <div v-if="showTaskModal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex justify-center items-center z-50 p-4">
                <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all scale-100 border border-slate-700">
                    <div class="bg-slate-900 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white">{{ isEditing ? 'タスク編集' : '新規タスク追加' }}</h3>
                        <button @click="showTaskModal = false" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <div v-if="clients.length === 0" class="bg-amber-900/30 text-amber-200 p-3 rounded text-sm mb-4 border border-amber-800">
                            <i class="fa-solid fa-exclamation-triangle mr-1"></i> まず設定画面からクライアントを登録してください。
                        </div>
                        
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">クライアント <span class="text-red-400">*</span></label>
                                <div v-if="isEditing">
                                    <select v-model="editingTaskData.clientId" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm text-white">
                                        <option v-for="c in clients" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <p class="text-[10px] text-yellow-500 mt-1" v-if="isEditing"><i class="fa-solid fa-triangle-exclamation mr-1"></i>変更すると全ての媒体タスクがこの顧客に移動します</p>
                                </div>
                                <div v-else class="h-40 overflow-y-auto bg-slate-700 border border-slate-600 rounded-lg p-2">
                                    <div v-for="c in clients" :key="c.id" class="flex items-center mb-1 last:mb-0 hover:bg-slate-600 p-1 rounded">
                                        <input type="checkbox" :value="c.id" v-model="editingTaskData.targetClientIds" :id="'client-'+c.id" class="w-4 h-4 text-blue-600 bg-slate-600 border-slate-500 rounded focus:ring-blue-500 ring-offset-slate-800">
                                        <label :for="'client-'+c.id" class="ml-2 text-sm text-slate-200 cursor-pointer select-none truncate flex-1 flex items-center">
                                            <span class="w-2 h-2 rounded-full mr-2" :class="getColor(c.color, 'bg')"></span>
                                            {{ c.name }}
                                        </label>
                                    </div>
                                    <div v-if="clients.length===0" class="text-xs text-slate-500 text-center mt-4">なし</div>
                                </div>
                                <p v-if="!isEditing" class="text-[10px] text-slate-400 mt-1"><i class="fa-solid fa-check-double mr-1"></i>複数選択で一括作成されます</p>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">媒体 <span class="text-red-400">*</span></label>
                                <div class="h-40 overflow-y-auto bg-slate-700 border border-slate-600 rounded-lg p-2">
                                    <div v-for="p in platforms" :key="p.name" class="flex items-center mb-1 last:mb-0 hover:bg-slate-600 p-1 rounded">
                                        <input type="checkbox" :value="p.name" v-model="editingTaskData.targetPlatforms" :id="'pf-'+p.name" class="w-4 h-4 text-blue-600 bg-slate-600 border-slate-500 rounded focus:ring-blue-500 ring-offset-slate-800">
                                        <label :for="'pf-'+p.name" class="ml-2 text-sm text-slate-200 cursor-pointer select-none truncate flex-1 flex items-center">
                                            <span class="w-2 h-2 rounded-full mr-2" :class="getColor(p.color, 'bg')"></span>
                                            {{ p.name }}
                                        </label>
                                    </div>
                                    <div v-if="platforms.length===0" class="text-xs text-slate-500 text-center mt-4">なし</div>
                                </div>
                                <p v-if="!isEditing" class="text-[10px] text-slate-400 mt-1"><i class="fa-solid fa-check-double mr-1"></i>(クライアント数) × (媒体数) のタスクが作成されます</p>
                                <p v-else class="text-[10px] text-slate-400 mt-1">選択された媒体でタスクを再構築します</p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">タスク名 <span class="text-red-400">*</span></label>
                            <input type="text" v-model="editingTaskData.title" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm text-white" placeholder="例: GWセール バナー入稿">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">詳細メモ</label>
                            <textarea v-model="editingTaskData.description" rows="3" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm text-white" placeholder="リンク先URLや特記事項など..."></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">開始日 / 切替日 <span class="text-red-400">*</span></label>
                                <input type="date" v-model="editingTaskData.date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm text-white">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">終了日 <span class="text-slate-500 font-normal">(任意)</span></label>
                                <input type="date" v-model="editingTaskData.endDate" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm text-white">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">ステータス</label>
                            <select v-model="editingTaskData.status" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm text-white">
                                <option value="Scheduled">Scheduled (予定)</option>
                                <option value="Live">Live (掲載中)</option>
                                <option value="Done">Done (完了)</option>
                            </select>
                        </div>
                    </div>

                    <div class="px-6 py-4 bg-slate-900 flex justify-end space-x-3 border-t border-slate-800">
                        <button @click="showTaskModal = false" class="px-5 py-2 bg-slate-800 border border-slate-600 rounded-lg text-slate-300 hover:bg-slate-700 text-sm font-medium transition">キャンセル</button>
                        <button @click="saveTask" :disabled="clients.length === 0" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 text-sm font-bold shadow-lg shadow-blue-900/50 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            {{ isEditing ? '更新する' : ( (editingTaskData.targetClientIds.length * editingTaskData.targetPlatforms.length) > 1 ? (editingTaskData.targetClientIds.length * editingTaskData.targetPlatforms.length) + '件を一括登録' : '追加する') }}
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Settings Modal -->
        <transition name="modal">
            <div v-if="showSettingsModal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex justify-center items-center z-50 p-4">
                <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden h-3/4 flex flex-col border border-slate-700">
                    <div class="bg-slate-900 px-6 py-4 flex justify-between items-center text-white shrink-0 border-b border-slate-700">
                        <h3 class="text-lg font-bold"><i class="fa-solid fa-sliders mr-2"></i>設定・マスタ管理</h3>
                        <button @click="showSettingsModal = false" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
                    </div>
                    
                    <div class="flex flex-1 overflow-hidden">
                        <!-- Settings Sidebar -->
                        <div class="w-48 bg-slate-900 border-r border-slate-700 p-4 flex flex-col space-y-2">
                            <button @click="settingsTab = 'clients'" :class="settingsTab === 'clients' ? 'bg-blue-900/40 text-blue-400 font-bold border border-blue-800' : 'text-slate-400 hover:bg-slate-800'" class="w-full text-left px-4 py-2 rounded-lg text-sm transition">
                                <i class="fa-regular fa-building mr-2 w-4 text-center"></i> 顧客管理
                            </button>
                            <button @click="settingsTab = 'platforms'" :class="settingsTab === 'platforms' ? 'bg-blue-900/40 text-blue-400 font-bold border border-blue-800' : 'text-slate-400 hover:bg-slate-800'" class="w-full text-left px-4 py-2 rounded-lg text-sm transition">
                                <i class="fa-solid fa-desktop mr-2 w-4 text-center"></i> 媒体設定
                            </button>
                            <button @click="settingsTab = 'data'" :class="settingsTab === 'data' ? 'bg-blue-900/40 text-blue-400 font-bold border border-blue-800' : 'text-slate-400 hover:bg-slate-800'" class="w-full text-left px-4 py-2 rounded-lg text-sm transition">
                                <i class="fa-solid fa-database mr-2 w-4 text-center"></i> データ管理
                            </button>
                        </div>

                        <!-- Settings Content -->
                        <div class="flex-1 p-6 overflow-y-auto bg-slate-800">
                            <!-- 顧客管理タブ -->
                            <div v-if="settingsTab === 'clients'">
                                <h4 class="text-lg font-bold text-slate-200 mb-4 border-b border-slate-700 pb-2">顧客リスト編集</h4>
                                <div class="flex space-x-2 mb-6">
                                    <color-picker v-model="newClientColor" :colors="COLORS" class="w-24"></color-picker>
                                    <input type="text" v-model="newClientName" @keyup.enter="addClient" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none text-white placeholder-slate-400" placeholder="新しい顧客名を入力">
                                    <button @click="addClient" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm transition">
                                        <i class="fa-solid fa-plus"></i> 追加
                                    </button>
                                </div>
                                <div class="space-y-2">
                                    <div v-for="client in clients" :key="client.id" class="flex justify-between items-center bg-slate-700 border border-slate-600 p-2 rounded-lg shadow-sm group hover:border-blue-500 transition border-l-4" :class="getColor(client.color, 'border')">
                                        <div class="flex items-center flex-1">
                                            <color-picker v-model="client.color" :colors="COLORS" :compact="true" @update:model-value="saveData"></color-picker>
                                            <span class="font-medium text-slate-200 ml-2">{{ client.name }}</span>
                                        </div>
                                        <button @click="removeClient(client.id)" class="text-slate-400 hover:text-red-400 px-2 py-1 rounded hover:bg-slate-600 transition">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </div>
                                    <div v-if="clients.length === 0" class="text-center text-slate-500 text-sm py-4">顧客が登録されていません</div>
                                </div>
                            </div>

                            <!-- 媒体管理タブ -->
                            <div v-if="settingsTab === 'platforms'">
                                <h4 class="text-lg font-bold text-slate-200 mb-4 border-b border-slate-700 pb-2">広告媒体リスト編集</h4>
                                <div class="flex space-x-2 mb-6">
                                    <color-picker v-model="newPlatformColor" :colors="COLORS" class="w-24"></color-picker>
                                    <input type="text" v-model="newPlatformName" @keyup.enter="addPlatform" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none text-white placeholder-slate-400" placeholder="新しい媒体名を入力">
                                    <button @click="addPlatform" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm transition">
                                        <i class="fa-solid fa-plus"></i> 追加
                                    </button>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div v-for="pf in platforms" :key="pf.name" class="flex justify-between items-center bg-slate-700 border border-slate-600 p-2 rounded-lg shadow-sm group hover:border-blue-500 transition">
                                        <div class="flex items-center flex-1">
                                            <color-picker v-model="pf.color" :colors="COLORS" :compact="true" @update:model-value="saveData"></color-picker>
                                            <span class="font-medium text-slate-200 text-sm ml-2">{{ pf.name }}</span>
                                        </div>
                                        <button @click="removePlatform(pf.name)" class="text-slate-400 hover:text-red-400 px-2 py-1 rounded hover:bg-slate-600 transition">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                             <!-- データ管理タブ -->
                             <div v-if="settingsTab === 'data'">
                                <h4 class="text-lg font-bold text-slate-200 mb-4 border-b border-slate-700 pb-2">データ管理</h4>
                                <div class="bg-red-900/20 border border-red-900/50 p-4 rounded-lg">
                                    <h5 class="text-red-400 font-bold text-sm mb-2"><i class="fa-solid fa-triangle-exclamation mr-1"></i> 全データ削除</h5>
                                    <p class="text-red-300/70 text-xs mb-4">登録したすべての顧客、媒体、タスクデータを削除し初期化します。この操作は取り消せません。</p>
                                    <button @click="resetAllData" class="bg-transparent border border-red-800 text-red-400 hover:bg-red-900/50 hover:text-red-200 px-4 py-2 rounded text-sm font-bold transition">
                                        全てのデータをリセット
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp } = Vue;

        // Custom Color Picker Component
        const ColorPicker = {
            props: ['modelValue', 'colors', 'compact'],
            emits: ['update:modelValue'],
            template: `
                <div class="relative inline-block text-left">
                    <!-- Trigger -->
                    <button @click="isOpen = !isOpen" type="button" 
                        class="inline-flex items-center justify-between rounded-lg border border-slate-600 shadow-sm transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
                        :class="compact ? 'p-1.5 hover:bg-slate-600 border-none bg-transparent' : 'w-full px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white'">
                        
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full flex-shrink-0" :class="colors[modelValue]?.dot || 'bg-slate-500'"></span>
                            <span v-if="!compact" class="ml-2 text-xs font-medium">{{ colors[modelValue]?.label || '選択' }}</span>
                        </div>
                        <i v-if="!compact" class="fa-solid fa-chevron-down ml-2 text-[10px] text-slate-400"></i>
                    </button>

                    <!-- Dropdown Backdrop (Invisible) -->
                    <div v-if="isOpen" @click="isOpen = false" class="fixed inset-0 z-40"></div>

                    <!-- Dropdown Menu -->
                    <div v-if="isOpen" class="absolute left-0 mt-1 w-32 rounded-md shadow-xl bg-slate-800 ring-1 ring-black ring-opacity-20 z-50 max-h-60 overflow-y-auto border border-slate-700 custom-scrollbar">
                        <div class="py-1">
                            <div v-for="(val, key) in colors" :key="key" 
                                @click="select(key)"
                                class="flex items-center px-4 py-2 text-xs text-slate-200 hover:bg-slate-700 cursor-pointer transition-colors"
                                :class="{'bg-slate-700': modelValue === key}">
                                <span class="w-3 h-3 rounded-full mr-3 flex-shrink-0" :class="val.dot"></span>
                                {{ val.label }}
                            </div>
                        </div>
                    </div>
                </div>
            `,
            data() { return { isOpen: false } },
            methods: {
                select(key) {
                    this.$emit('update:modelValue', key);
                    this.isOpen = false;
                }
            }
        };

        // Enhanced Color Palette
        const COLORS = {
            red: { label: '赤', border: 'border-red-500', bg: 'bg-red-500', dot: 'bg-red-500', tag: 'bg-red-900/40 text-red-300 border-red-800' },
            orange: { label: '橙', border: 'border-orange-500', bg: 'bg-orange-500', dot: 'bg-orange-500', tag: 'bg-orange-900/40 text-orange-300 border-orange-800' },
            amber: { label: '黄', border: 'border-amber-500', bg: 'bg-amber-500', dot: 'bg-amber-500', tag: 'bg-amber-900/40 text-amber-300 border-amber-800' },
            lime: { label: '黄緑', border: 'border-lime-500', bg: 'bg-lime-500', dot: 'bg-lime-500', tag: 'bg-lime-900/40 text-lime-300 border-lime-800' },
            green: { label: '緑', border: 'border-green-500', bg: 'bg-green-500', dot: 'bg-green-500', tag: 'bg-green-900/40 text-green-300 border-green-800' },
            emerald: { label: '深緑', border: 'border-emerald-500', bg: 'bg-emerald-500', dot: 'bg-emerald-500', tag: 'bg-emerald-900/40 text-emerald-300 border-emerald-800' },
            teal: { label: '青緑', border: 'border-teal-500', bg: 'bg-teal-500', dot: 'bg-teal-500', tag: 'bg-teal-900/40 text-teal-300 border-teal-800' },
            cyan: { label: '水色', border: 'border-cyan-500', bg: 'bg-cyan-500', dot: 'bg-cyan-500', tag: 'bg-cyan-900/40 text-cyan-300 border-cyan-800' },
            blue: { label: '青', border: 'border-blue-500', bg: 'bg-blue-500', dot: 'bg-blue-500', tag: 'bg-blue-900/40 text-blue-300 border-blue-800' },
            indigo: { label: '藍', border: 'border-indigo-500', bg: 'bg-indigo-500', dot: 'bg-indigo-500', tag: 'bg-indigo-900/40 text-indigo-300 border-indigo-800' },
            purple: { label: '紫', border: 'border-purple-500', bg: 'bg-purple-500', dot: 'bg-purple-500', tag: 'bg-purple-900/40 text-purple-300 border-purple-800' },
            fuchsia: { label: '赤紫', border: 'border-fuchsia-500', bg: 'bg-fuchsia-500', dot: 'bg-fuchsia-500', tag: 'bg-fuchsia-900/40 text-fuchsia-300 border-fuchsia-800' },
            pink: { label: '桃', border: 'border-pink-500', bg: 'bg-pink-500', dot: 'bg-pink-500', tag: 'bg-pink-900/40 text-pink-300 border-pink-800' },
            rose: { label: '紅', border: 'border-rose-500', bg: 'bg-rose-500', dot: 'bg-rose-500', tag: 'bg-rose-900/40 text-rose-300 border-rose-800' },
            slate: { label: '灰', border: 'border-slate-500', bg: 'bg-slate-500', dot: 'bg-slate-500', tag: 'bg-slate-700 text-slate-300 border-slate-600' },
        };

        const app = createApp({
            data() {
                return {
                    COLORS,
                    isSidebarOpen: true, 
                    viewMode: 'list', 
                    currentClient: null,
                    filterPlatform: '',
                    ganttYear: new Date().getFullYear(),
                    ganttMonth: new Date().getMonth(),
                    showTaskModal: false,
                    showSettingsModal: false,
                    settingsTab: 'clients',
                    isEditing: false,
                    newClientName: '',
                    newClientColor: 'blue',
                    newPlatformName: '',
                    newPlatformColor: 'green',
                    editingTaskData: {
                        id: null,
                        clientId: '', 
                        targetClientIds: [],
                        platform: '', 
                        targetPlatforms: [], 
                        title: '',
                        description: '',
                        date: '',
                        endDate: '', 
                        status: 'Scheduled',
                        createdAt: null,
                        originalIds: [] 
                    },
                    platforms: [],
                    clients: [],
                    tasks: []
                }
            },
            computed: {
                filteredTasks() {
                    let filtered = this.tasks;
                    if (this.currentClient) {
                        filtered = filtered.filter(t => t.clientId === this.currentClient.id);
                    }
                    if (this.filterPlatform) {
                        filtered = filtered.filter(t => t.platform === this.filterPlatform);
                    }
                    return filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
                },
                groupedFilteredTasks() {
                    return this.groupTasks(this.filteredTasks);
                },
                allPendingTasksCount() {
                    return this.tasks.filter(t => t.status !== 'Done').length;
                },
                boardData() {
                    let targetClients = this.currentClient ? [this.currentClient] : this.clients;
                    return targetClients.map(client => {
                        const rawClientTasks = this.tasks.filter(t => {
                            if (t.clientId !== client.id) return false;
                            if (this.filterPlatform && t.platform !== this.filterPlatform) return false;
                            return true;
                        }).sort((a, b) => new Date(a.date) - new Date(b.date));
                        const groupedClientTasks = this.groupTasks(rawClientTasks);
                        return { client: client, tasks: groupedClientTasks };
                    });
                },
                daysInMonth() {
                    const year = this.ganttYear;
                    const month = this.ganttMonth;
                    const date = new Date(year, month, 1);
                    const days = [];
                    const weekDays = ['日','月','火','水','木','金','土'];
                    while (date.getMonth() === month) {
                        const dayVal = new Date(date);
                        days.push({
                            date: dayVal.toISOString().split('T')[0],
                            day: dayVal.getDate(),
                            weekDay: weekDays[dayVal.getDay()],
                            isHoliday: dayVal.getDay() === 0 || dayVal.getDay() === 6,
                            isToday: dayVal.toDateString() === new Date().toDateString(),
                            obj: dayVal
                        });
                        date.setDate(date.getDate() + 1);
                    }
                    return days;
                },
                ganttRows() {
                    if (this.currentClient) {
                        return this.platforms.map(pf => {
                            return {
                                key: pf.name,
                                label: pf.name,
                                color: pf.color,
                                clientId: this.currentClient.id, 
                                tasks: this.tasks.filter(t => 
                                    t.clientId === this.currentClient.id && 
                                    t.platform === pf.name &&
                                    this.isTaskInCurrentMonth(t)
                                )
                            };
                        });
                    } else {
                        return this.clients.map(c => {
                            return {
                                key: c.id,
                                label: c.name,
                                clientId: c.id, 
                                tasks: this.tasks.filter(t => 
                                    t.clientId === c.id &&
                                    this.isTaskInCurrentMonth(t)
                                )
                            };
                        });
                    }
                }
            },
            mounted() {
                this.loadData();
            },
            methods: {
                loadData() {
                    const savedData = localStorage.getItem('ad_manager_db_v1');
                    if (savedData) {
                        const db = JSON.parse(savedData);
                        this.clients = (db.clients || []).map(c => ({
                            ...c,
                            color: c.color || this.getRandomColorKey()
                        }));
                        this.platforms = (db.platforms || []).map(p => {
                            if (typeof p === 'string') {
                                const map = {
                                    'Google': 'green', 'Google広告': 'green',
                                    'YSS': 'red', 'Yahoo!検索': 'red',
                                    'YDN': 'red', 'Yahoo!ディスプレイ': 'red',
                                    'LINE': 'lime', 'LINE広告': 'lime',
                                    'meta': 'purple', 'Meta広告': 'purple', 'Meta': 'purple',
                                    'TVer': 'cyan'
                                };
                                return { name: p, color: map[p] || this.getRandomColorKey() };
                            }
                            return p;
                        });
                        this.tasks = db.tasks || [];
                    } else {
                        this.platforms = [
                            { name: 'Google', color: 'green' },
                            { name: 'YSS', color: 'red' },
                            { name: 'YDN', color: 'red' },
                            { name: 'LINE', color: 'lime' },
                            { name: 'meta', color: 'purple' },
                            { name: 'TVer', color: 'cyan' }
                        ];
                        this.clients = [{ id: 1, name: 'サンプル株式会社', color: 'blue' }];
                        this.tasks = [{ id: Date.now(), clientId: 1, platform: 'Google', title: '【例】初期設定', description: '...', date: new Date().toISOString().split('T')[0], status: 'Scheduled', createdAt: new Date().toISOString() }];
                        this.saveData();
                    }
                },
                saveData() {
                    const db = {
                        clients: this.clients,
                        platforms: this.platforms,
                        tasks: this.tasks
                    };
                    localStorage.setItem('ad_manager_db_v1', JSON.stringify(db));
                },
                resetAllData() {
                    if(confirm('本当に全てのデータを削除して初期化しますか？')) {
                        localStorage.removeItem('ad_manager_db_v1');
                        location.reload();
                    }
                },
                getRandomColorKey() {
                    const keys = Object.keys(COLORS);
                    return keys[Math.floor(Math.random() * keys.length)];
                },
                getColor(colorKey, type) {
                    const c = COLORS[colorKey] || COLORS['slate'];
                    return c[type];
                },
                getClientColor(clientId, type) {
                    const client = this.clients.find(c => c.id === clientId);
                    const colorKey = client ? client.color : 'slate';
                    return this.getColor(colorKey, type);
                },
                getClientColorBg(clientId) {
                    return this.getClientColor(clientId, 'bg');
                },
                getClientColorBorder(clientId) {
                    return this.getClientColor(clientId, 'border');
                },
                getPlatformColorStyle(pfName) {
                    const pf = this.platforms.find(p => p.name === pfName);
                    const colorKey = pf ? pf.color : 'slate';
                    return this.getColor(colorKey, 'tag');
                },
                getPlatformColorDot(pfName) {
                    const pf = this.platforms.find(p => p.name === pfName);
                    const colorKey = pf ? pf.color : 'slate';
                    return this.getColor(colorKey, 'dot');
                },
                groupTasks(tasks) {
                    const groups = {};
                    tasks.forEach(task => {
                        const key = `${task.clientId}_${task.title}_${task.date}`;
                        if (!groups[key]) {
                            groups[key] = {
                                ...task, 
                                uniqueKey: key,
                                platforms: [], 
                                originalIds: [], 
                                statusMix: [], 
                            };
                        }
                        if (!groups[key].platforms.includes(task.platform)) {
                            groups[key].platforms.push(task.platform);
                        }
                        groups[key].originalIds.push(task.id);
                        groups[key].statusMix.push(task.status);
                    });
                    return Object.values(groups).map(group => {
                        const allDone = group.statusMix.every(s => s === 'Done');
                        const anyLive = group.statusMix.some(s => s === 'Live');
                        if (allDone) group.status = 'Done';
                        else if (anyLive) group.status = 'Live';
                        else group.status = 'Scheduled';
                        return group;
                    });
                },
                selectClient(client) {
                    this.currentClient = client;
                },
                openSettings(tab = 'clients') {
                    this.settingsTab = tab;
                    this.showSettingsModal = true;
                },
                getStatusClass(status) {
                    if (status === 'Done') return 'text-emerald-400 bg-emerald-900/30 border-emerald-800';
                    if (status === 'Live') return 'text-blue-400 bg-blue-900/30 border-blue-800';
                    return 'text-amber-400 bg-amber-900/30 border-amber-800';
                },
                getStatusDotClass(status) {
                    if (status === 'Done') return 'bg-emerald-500';
                    if (status === 'Live') return 'bg-blue-500';
                    return 'bg-amber-500';
                },
                getStatusIcon(status) {
                    if (status === 'Done') return 'fa-solid fa-check';
                    if (status === 'Live') return 'fa-solid fa-play';
                    return 'fa-solid fa-hourglass-half';
                },
                getStatusLabel(status) {
                    if (status === 'Done') return '完了';
                    if (status === 'Live') return '掲載中';
                    return '予定';
                },
                getClientName(id) {
                    const c = this.clients.find(c => c.id === id);
                    return c ? c.name : '不明な顧客';
                },
                getPendingCount(clientId) {
                    return this.tasks.filter(t => t.clientId === clientId && t.status !== 'Done').length;
                },
                formatDateRange(task) {
                    const d1 = this.formatDate(task.date);
                    if (!task.endDate) return d1;
                    const d2 = this.formatDate(task.endDate);
                    return `${d1} 〜 ${d2}`;
                },
                formatDate(dateStr) {
                    if (!dateStr) return '';
                    const d = new Date(dateStr);
                    return `${d.getMonth() + 1}/${d.getDate()}`;
                },
                formatCreatedDate(isoStr) {
                    if (!isoStr) return '';
                    const d = new Date(isoStr);
                    return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                },
                formatCreatedDateShort(isoStr) {
                    if (!isoStr) return '';
                    const d = new Date(isoStr);
                    return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                },
                isOverdue(task) {
                    if(task.status === 'Done') return false;
                    const today = new Date().toISOString().split('T')[0];
                    const targetDate = task.endDate || task.date;
                    return targetDate < today;
                },
                changeGanttMonth(delta) {
                    let m = this.ganttMonth + delta;
                    let y = this.ganttYear;
                    if (m > 11) { m = 0; y++; }
                    if (m < 0) { m = 11; y--; }
                    this.ganttMonth = m;
                    this.ganttYear = y;
                },
                resetGanttDate() {
                    const d = new Date();
                    this.ganttYear = d.getFullYear();
                    this.ganttMonth = d.getMonth();
                },
                isTaskInCurrentMonth(task) {
                    const taskStart = new Date(task.date);
                    const taskEnd = task.endDate ? new Date(task.endDate) : taskStart;
                    const monthStart = new Date(this.ganttYear, this.ganttMonth, 1);
                    const monthEnd = new Date(this.ganttYear, this.ganttMonth + 1, 0);
                    return (taskStart <= monthEnd) && (taskEnd >= monthStart);
                },
                getTaskStyle(task) {
                    const CELL_WIDTH = 40; 
                    const taskStart = new Date(task.date);
                    const taskEnd = task.endDate ? new Date(task.endDate) : taskStart;
                    const isPoint = !task.endDate || task.date === task.endDate;
                    const monthStart = new Date(this.ganttYear, this.ganttMonth, 1);
                    const monthEnd = new Date(this.ganttYear, this.ganttMonth + 1, 0);
                    let start = taskStart < monthStart ? monthStart : taskStart;
                    let end = taskEnd > monthEnd ? monthEnd : taskEnd;
                    const startDayIndex = start.getDate() - 1;
                    let durationDays = (end.getDate() - start.getDate()) + 1;
                    const left = startDayIndex * CELL_WIDTH;
                    let width = durationDays * CELL_WIDTH;
                    if (isPoint) {
                        return { left: (left + 10) + 'px', width: '20px', isPoint: true };
                    }
                    return { left: left + 'px', width: (width - 4) + 'px', marginLeft: '2px', isPoint: false };
                },
                openTaskModal() {
                    this.isEditing = false;
                    const initialTargetClients = this.currentClient ? [this.currentClient.id] : [];
                    const initialTargetPlatforms = this.platforms.length > 0 ? [this.platforms[0].name] : [];
                    this.editingTaskData = {
                        id: null,
                        clientId: this.currentClient ? this.currentClient.id : (this.clients[0]?.id || ''),
                        targetClientIds: initialTargetClients,
                        targetPlatforms: initialTargetPlatforms,
                        title: '',
                        description: '',
                        date: new Date().toISOString().split('T')[0],
                        endDate: '',
                        status: 'Scheduled',
                        createdAt: null,
                        originalIds: []
                    };
                    this.showTaskModal = true;
                },
                editGroup(taskGroup) {
                    this.isEditing = true;
                    const data = JSON.parse(JSON.stringify(taskGroup));
                    this.editingTaskData = {
                        ...data,
                        clientId: data.clientId, 
                        targetPlatforms: data.platforms || [data.platform], 
                        targetClientIds: [], 
                        originalIds: data.originalIds || [data.id] 
                    };
                    this.showTaskModal = true;
                },
                duplicateGroup(taskGroup) {
                    this.isEditing = false;
                    const data = JSON.parse(JSON.stringify(taskGroup));
                    this.editingTaskData = {
                        ...data,
                        id: null,
                        title: data.title,
                        status: 'Scheduled',
                        createdAt: null,
                        targetClientIds: [], 
                        targetPlatforms: data.platforms || [data.platform], 
                        originalIds: [] 
                    };
                    this.showTaskModal = true;
                },
                saveTask() {
                    if (!this.editingTaskData.title || !this.editingTaskData.date) {
                        alert('タスク名と日付は必須です');
                        return;
                    }
                    if (this.isEditing) {
                        if(!this.editingTaskData.clientId) { alert('クライアントを選択してください'); return; }
                        if(this.editingTaskData.targetPlatforms.length === 0) { alert('媒体を1つ以上選択してください'); return; }
                        if (this.editingTaskData.originalIds && this.editingTaskData.originalIds.length > 0) {
                            this.tasks = this.tasks.filter(t => !this.editingTaskData.originalIds.includes(t.id));
                        }
                        const baseData = { ...this.editingTaskData };
                        delete baseData.targetClientIds; 
                        delete baseData.targetPlatforms;
                        delete baseData.originalIds;
                        delete baseData.platforms; 
                        delete baseData.uniqueKey; 
                        delete baseData.statusMix; 
                        this.editingTaskData.targetPlatforms.forEach(platform => {
                            const newTask = {
                                ...baseData,
                                id: Date.now() + Math.random(),
                                clientId: this.editingTaskData.clientId,
                                platform: platform
                            };
                            this.tasks.push(newTask);
                        });
                    } else {
                        if(this.editingTaskData.targetClientIds.length === 0) {
                            alert('クライアントを1つ以上選択してください');
                            return;
                        }
                        if(this.editingTaskData.targetPlatforms.length === 0) {
                            alert('媒体を1つ以上選択してください');
                            return;
                        }
                        const baseData = { ...this.editingTaskData };
                        delete baseData.targetClientIds; 
                        delete baseData.targetPlatforms;
                        delete baseData.id;
                        delete baseData.originalIds;
                        baseData.createdAt = new Date().toISOString();
                        this.editingTaskData.targetClientIds.forEach(clientId => {
                            this.editingTaskData.targetPlatforms.forEach(platform => {
                                const newTask = {
                                    ...baseData,
                                    id: Date.now() + Math.random(),
                                    clientId: clientId,
                                    platform: platform
                                };
                                this.tasks.push(newTask);
                            });
                        });
                    }
                    this.saveData();
                    this.showTaskModal = false;
                },
                toggleGroupStatus(taskGroup) {
                    const map = { 'Scheduled': 'Live', 'Live': 'Done', 'Done': 'Scheduled' };
                    const nextStatus = map[taskGroup.status] || 'Scheduled';
                    const idsToUpdate = taskGroup.originalIds || [taskGroup.id];
                    this.tasks.forEach(t => {
                        if (idsToUpdate.includes(t.id)) {
                            t.status = nextStatus;
                        }
                    });
                    this.saveData();
                },
                deleteGroup(taskGroup) {
                    if(confirm('表示されている全ての媒体タスクを削除しますか？')) {
                        const idsToDelete = taskGroup.originalIds || [taskGroup.id];
                        this.tasks = this.tasks.filter(t => !idsToDelete.includes(t.id));
                        this.saveData();
                    }
                },
                addClient() {
                    if(!this.newClientName.trim()) return;
                    this.clients.push({
                        id: Date.now(),
                        name: this.newClientName.trim(),
                        color: this.newClientColor
                    });
                    this.newClientName = '';
                    this.saveData();
                },
                removeClient(id) {
                    if(confirm('この顧客と関連タスクを削除してもよろしいですか？')) {
                        this.clients = this.clients.filter(c => c.id !== id);
                        this.saveData();
                        if(this.currentClient && this.currentClient.id === id) {
                            this.currentClient = null;
                        }
                    }
                },
                addPlatform() {
                    if(!this.newPlatformName.trim()) return;
                    if(this.platforms.find(p => p.name === this.newPlatformName.trim())) return;
                    this.platforms.push({
                        name: this.newPlatformName.trim(),
                        color: this.newPlatformColor
                    });
                    this.newPlatformName = '';
                    this.saveData();
                },
                removePlatform(name) {
                    if(confirm(`媒体「${name}」をリストから削除しますか？`)) {
                        this.platforms = this.platforms.filter(p => p.name !== name);
                        this.saveData();
                    }
                }
            }
        });

        app.component('color-picker', ColorPicker);
        app.mount('#app');
    </script>
</body>
</html>
